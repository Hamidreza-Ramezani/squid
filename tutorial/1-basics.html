<html><head><title>Squid: Basic Concepts</title><meta charset="utf-8" /><meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1" /><meta name="viewport" content="width=device-width, initial-scale=1.0" /><meta name="author" content="Lionel Parreaux (@lptk)" /><meta name="description" content="Squid ― type-safe metaprogramming for Scala" /><meta name="og:image" content="/squid/img/poster.png" /><meta name="og:title" content="Squid: Basic Concepts" /><meta name="og:site_name" content="Squid" /><meta name="og:url" content="" /><meta name="og:type" content="website" /><meta name="og:description" content="Squid ― type-safe metaprogramming for Scala" /><link rel="icon" type="image/png" href="/squid/img/favicon.png" /><meta name="twitter:title" content="Squid: Basic Concepts" /><meta name="twitter:image" content="img/poster.png" /><meta name="twitter:description" content="Squid ― type-safe metaprogramming for Scala" /><meta name="twitter:card" content="summary_large_image" /><link rel="icon" type="image/png" sizes="16x16" href="/squid/img/favicon16x16.png" /><link rel="icon" type="image/png" sizes="24x24" href="/squid/img/favicon24x24.png" /><link rel="icon" type="image/png" sizes="32x32" href="/squid/img/favicon32x32.png" /><link rel="icon" type="image/png" sizes="48x48" href="/squid/img/favicon48x48.png" /><link rel="icon" type="image/png" sizes="57x57" href="/squid/img/favicon57x57.png" /><link rel="icon" type="image/png" sizes="60x60" href="/squid/img/favicon60x60.png" /><link rel="icon" type="image/png" sizes="64x64" href="/squid/img/favicon64x64.png" /><link rel="icon" type="image/png" sizes="70x70" href="/squid/img/favicon70x70.png" /><link rel="icon" type="image/png" sizes="72x72" href="/squid/img/favicon72x72.png" /><link rel="icon" type="image/png" sizes="76x76" href="/squid/img/favicon76x76.png" /><link rel="icon" type="image/png" sizes="96x96" href="/squid/img/favicon96x96.png" /><link rel="icon" type="image/png" sizes="114x114" href="/squid/img/favicon114x114.png" /><link rel="icon" type="image/png" sizes="120x120" href="/squid/img/favicon120x120.png" /><link rel="icon" type="image/png" sizes="128x128" href="/squid/img/favicon128x128.png" /><link rel="icon" type="image/png" sizes="144x144" href="/squid/img/favicon144x144.png" /><link rel="icon" type="image/png" sizes="150x150" href="/squid/img/favicon150x150.png" /><link rel="icon" type="image/png" sizes="152x152" href="/squid/img/favicon152x152.png" /><link rel="icon" type="image/png" sizes="196x196" href="/squid/img/favicon196x196.png" /><link rel="icon" type="image/png" sizes="310x310" href="/squid/img/favicon310x310.png" /><link rel="icon" type="image/png" sizes="310x150" href="/squid/img/favicon310x150.png" /><link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.7/css/bootstrap.min.css" /><link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/font-awesome/4.7.0/css/font-awesome.min.css" /><link rel="stylesheet" href="/squid/highlight/styles/atom-one-light.css" /><link rel="stylesheet" href="/squid/css/style.css" /><link rel="stylesheet" href="/squid/css/palette.css" /><link rel="stylesheet" href="/squid/css/codemirror.css" /></head><body class="docs"><div id="wrapper"><div id="sidebar-wrapper"><ul id="sidebar" class="sidebar-nav"><li class="sidebar-brand"><a href="/squid/" class="brand"><div class="brand-wrapper"><span>Squid</span></div></a></li> <li><a href="/squid/tutorial" class="">Squid Tutorial</a> <ul class="sub_section"> <li><a href="/squid/tutorial/0-getting-started.html" class="">»  Getting Started</a></li> <li><a href="/squid/tutorial/1-basics.html" class="">»  Basic Concepts</a></li> <li><a href="/squid/tutorial/2-staging.html" class="">»  Multi-Stage Programming</a></li> <li><a href="/squid/tutorial/3-matching.html" class="">»  Code Pattern Matching</a></li> <li><a href="/squid/tutorial/4-rewriting.html" class="">»  Code Rewriting</a></li> <li><a href="/squid/tutorial/5-advanced.html" class="">»  Advanced Topics on Quasiquotes and Rewriting</a></li> <li><a href="/squid/tutorial/6-debugging.html" class="">»  Debugging Quasiquotes and Rewritings</a></li></ul></li> </ul></div><div id="page-content-wrapper"><div class="nav"><div class="container-fluid"><div class="row"><div class="col-lg-12"><div class="action-menu pull-left clearfix"><a href="#menu-toggle" id="menu-toggle"><i class="fa fa-bars" aria-hidden="true"></i></a></div><ul class="pull-right"><li id="gh-eyes-item" class="hidden-xs"><a href="https://github.com/epfldata/squid"><i class="fa fa-eye"></i><span>WATCH<span id="eyes" class="label label-default">--</span></span></a></li><li id="gh-stars-item" class="hidden-xs"><a href="https://github.com/epfldata/squid"><i class="fa fa-star-o"></i><span>STARS<span id="stars" class="label label-default">--</span></span></a></li><li><a href="#" onclick="shareSiteTwitter('Squid Squid ― type-safe metaprogramming for Scala');"><i class="fa fa-twitter"></i></a></li><li><a href="#" onclick="shareSiteFacebook('Squid Squid ― type-safe metaprogramming for Scala');"><i class="fa fa-facebook"></i></a></li><li><a href="#" onclick="shareSiteGoogle();"><i class="fa fa-google-plus"></i></a></li></ul></div></div></div></div><div id="content" data-github-owner="epfldata" data-github-repo="squid"><div class="content-wrapper"><section><h1 id="basic-concepts">Basic Concepts</h1>

<h2 id="setting-up-an-ir">Setting Up an IR</h2>

<p>The only step required before we can start manipulating programs in Squid
is to instantiate an intermediate representation (IR)
to manipulate the programs in.
Different configurable IRs are provided by Squid with different properties,
pros, and cons that you should consider in light of your intended use cases.</p>

<p>The choice of an IR impacts the way programs are internally represented,
and thus affects the semantics of some operations performed on code fragments,
such as pattern-matching and transformation.
More on that is explained in the
<a href="https://github.com/epfldata/squid/blob/master/doc/Intermediate_Representations.md">Intermediate Representation</a> reference;
for now, we will just use the simplest IR there is:
a simple abstract syntax tree (AST).
To instantiate this IR, proceed as follows:</p>

<div class="language-scala highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">object</span> <span class="nc">IR</span> <span class="k">extends</span> <span class="n">squid</span><span class="o">.</span><span class="n">ir</span><span class="o">.</span><span class="nc">SimpleAST</span>
<span class="k">import</span> <span class="nn">IR.Predef._</span>
</code></pre></div></div>

<p>Importing <code class="highlighter-rouge">IR.Predef._</code> brings into scope all the definitions we will need
in order to manipulate code in a type-safe way.
Note that it is important to <em>not</em> import the whole content of the IR with <code class="highlighter-rouge">import IR._</code>,
as this would import many more definitions not useful to us.</p>

<h2 id="types-of-programs">Types of Programs</h2>

<p>As part of an IR’s <code class="highlighter-rouge">Predef</code>, a few important types are defined.
They are summarized in the table below:</p>

<table>
  <thead>
    <tr>
      <th>Type</th>
      <th>Equivalent to</th>
      <th>Description</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <td><code class="highlighter-rouge">Code[T,C]</code></td>
      <td> </td>
      <td>code fragments of type <code class="highlighter-rouge">T</code> and context <code class="highlighter-rouge">C</code></td>
    </tr>
    <tr>
      <td><code class="highlighter-rouge">ClosedCode[T]</code></td>
      <td><code class="highlighter-rouge">Code[T,Any]</code></td>
      <td>closed code fragments</td>
    </tr>
    <tr>
      <td><code class="highlighter-rouge">OpenCode[T]</code></td>
      <td><code class="highlighter-rouge">Code[T,Nothing]</code></td>
      <td>open code fragments</td>
    </tr>
    <tr>
      <td><code class="highlighter-rouge">CodeType[T]</code></td>
      <td> </td>
      <td>program type representations</td>
    </tr>
    <tr>
      <td><code class="highlighter-rouge">Variable[T]</code></td>
      <td> </td>
      <td>variable symbols</td>
    </tr>
  </tbody>
</table>

<p><br />
Note that the <code class="highlighter-rouge">Code[+Typ,-Ctx]</code> class is covariant 
<!-- in its first parameter -->
in <code class="highlighter-rouge">Typ</code> and contravariant in <code class="highlighter-rouge">Ctx</code>,
so for any <code class="highlighter-rouge">T</code>, <code class="highlighter-rouge">C</code> and <code class="highlighter-rouge">D</code>,
we have the subtyping relations
<code class="highlighter-rouge">ClosedCode[T] &lt;: Code[T,C] &lt;: Code[T, C &amp; D] &lt;: OpenCode[T]</code>
<!-- Moreover, for any  -->
where <code class="highlighter-rouge">C &amp; D</code> is the intersection of types <code class="highlighter-rouge">C</code> and <code class="highlighter-rouge">D</code>,
equivalent to <code class="highlighter-rouge">C with D</code> in Scala.
These relations are explained and justified later in the Squid tutorial,
but intuitively a <em>closed</em> code fragment is one that can be used in <em>any</em> context (<code class="highlighter-rouge">C = Any</code>),
while an <em>open</em> code fragment is one that <em>no</em> context (<code class="highlighter-rouge">C = Nothing</code>)
can be statically guaranteed to satisfy.
The <code class="highlighter-rouge">&amp;</code> type operator is defined in <code class="highlighter-rouge">squid.utils</code>,
so to use it you will have to import <code class="highlighter-rouge">squid.utils._</code>
(or, more selectively <code class="highlighter-rouge">import squid.utils.&amp;</code>).</p>

<h2 id="quasiquotation-and-code-composition">Quasiquotation and Code Composition</h2>

<!-- note: the old QQ tutorial had much more bla bla here: https://github.com/epfldata/squid/blob/master/doc/tuto/Quasiquotes.md#introduction -->

<p>A quasiquote is a quote in which some “holes” are left to be filled in by arbitrary values.
The most well-known example of quasiquotation in Scala is interpolated string literals,
of syntax <code class="highlighter-rouge">s"..."</code> in which <code class="highlighter-rouge">$</code> is used to denote holes.
<!-- Consider the following example: -->
For example:</p>

<div class="language-scala highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">scala</span><span class="o">&gt;</span> <span class="k">val</span> <span class="n">a</span> <span class="k">=</span> <span class="n">s</span><span class="s">"2"</span>
<span class="n">a</span><span class="k">:</span> <span class="kt">String</span> <span class="o">=</span> <span class="mi">2</span>

<span class="n">scala</span><span class="o">&gt;</span> <span class="n">s</span><span class="s">"($a + $a) * 2"</span>  <span class="c1">// inserts 'a' into two quasiquote holes
</span><span class="n">res0</span><span class="k">:</span> <span class="kt">String</span> <span class="o">=</span> <span class="o">(</span><span class="mi">2</span> <span class="o">+</span> <span class="mi">2</span><span class="o">)</span> <span class="o">*</span> <span class="mi">2</span>
</code></pre></div></div>

<p>The primary way of manipulating programs in Squid is to use <em>code</em> quasiquotes,
which are like interpolated string literals,
except that instead of representing a sequence of characters,
they represent fragments of programs that are internally encoded in an intermediate representation (IR).</p>

<p>To use quasiquotes, do not forget to import your <code class="highlighter-rouge">IR.Predef._</code>, as explained above.
The syntax is <code class="highlighter-rouge">code"..."</code>, as shown below:</p>

<div class="language-scala highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">scala</span><span class="o">&gt;</span> <span class="k">val</span> <span class="n">a</span> <span class="k">=</span> <span class="n">code</span><span class="s">"2"</span>
<span class="n">a</span><span class="k">:</span> <span class="kt">IR.ClosedCode</span><span class="o">[</span><span class="kt">Int</span><span class="o">]</span> <span class="k">=</span> <span class="n">code</span><span class="s">"2"</span>

<span class="n">scala</span><span class="o">&gt;</span> <span class="n">code</span><span class="s">"($a + $a) * 2"</span>
<span class="n">res1</span><span class="k">:</span> <span class="kt">IR.ClosedCode</span><span class="o">[</span><span class="kt">Int</span><span class="o">]</span> <span class="k">=</span> <span class="n">code</span><span class="s">"(2).+(2).*(2)"</span>
</code></pre></div></div>

<p>Looking at the types in the REPL session above,
we can see that we are manipulating <em>closed terms</em> of type <code class="highlighter-rouge">Int</code>.
We also notice that the textual representation of the printed term
is different from the one we used in the original quasiquote,
because the term is internally represented in a normalized form by our IR,
where any information about parentheses and operator-syntax is lost.</p>

<p>The <code class="highlighter-rouge">Const</code> function can be used to <em>lift</em> normal values to terms (code values):</p>

<div class="language-scala highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">scala</span><span class="o">&gt;</span> <span class="nc">Const</span><span class="o">(</span><span class="mi">42</span><span class="o">)</span>
<span class="n">res2</span><span class="k">:</span> <span class="kt">IR.ClosedCode</span><span class="o">[</span><span class="kt">Int</span><span class="o">]</span> <span class="k">=</span> <span class="n">code</span><span class="s">"42"</span>

<span class="n">scala</span><span class="o">&gt;</span> <span class="nc">List</span><span class="o">(</span><span class="mi">1</span><span class="o">,</span><span class="mi">2</span><span class="o">,</span><span class="mi">3</span><span class="o">).</span><span class="n">map</span><span class="o">(</span><span class="n">n</span> <span class="k">=&gt;</span> <span class="n">code</span><span class="s">"${Const(n)}.toDouble"</span><span class="o">)</span>
<span class="n">res3</span><span class="k">:</span> <span class="kt">List</span><span class="o">[</span><span class="kt">IR.ClosedCode</span><span class="o">[</span><span class="kt">Double</span><span class="o">]]</span> <span class="k">=</span> <span class="nc">List</span><span class="o">(</span><span class="n">code</span><span class="s">"1.toDouble"</span><span class="o">,</span> <span class="n">code</span><span class="s">"2.toDouble"</span><span class="o">,</span> <span class="n">code</span><span class="s">"3.toDouble"</span><span class="o">)</span>
</code></pre></div></div>

<h2 id="quasicode-syntax-alternative">Quasi​<em>code</em> Syntax Alternative</h2>
<!-- ^ note: there is a zero-length space between 'Quasi' and '_code_'  -->

<p>The syntax <code class="highlighter-rouge">code{ ... $(x)... }</code>, referred to as <em>quasicode</em>,
can be used in place of <code class="highlighter-rouge">code" ... ${x}... "</code> in expression position (but not in <code class="highlighter-rouge">case</code> patterns).
This has several advantages, including good IDE integration – autocompletion, syntax and error highlighting, jump-to-definition, etc.</p>

<p>In order to use this syntax, import <code class="highlighter-rouge">IR.Quasicodes._</code> first. For example:</p>

<div class="language-scala highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">scala</span><span class="o">&gt;</span> <span class="k">import</span> <span class="nn">IR.Quasicodes._</span>
<span class="k">import</span> <span class="nn">IR.Quasicodes._</span>

<span class="n">scala</span><span class="o">&gt;</span> <span class="k">val</span> <span class="n">a</span> <span class="k">=</span> <span class="n">code</span><span class="o">{</span><span class="mi">2</span><span class="o">}</span>
<span class="n">a</span><span class="k">:</span> <span class="kt">IR.ClosedCode</span><span class="o">[</span><span class="kt">Int</span><span class="o">]</span> <span class="k">=</span> <span class="n">code</span><span class="s">"2"</span>

<span class="n">scala</span><span class="o">&gt;</span> <span class="n">code</span><span class="o">{(</span><span class="n">$</span><span class="o">(</span><span class="n">a</span><span class="o">)</span> <span class="o">+</span> <span class="n">$</span><span class="o">(</span><span class="n">a</span><span class="o">))</span> <span class="o">*</span> <span class="mi">2</span><span class="o">}</span>
<span class="n">res4</span><span class="k">:</span> <span class="kt">IR.ClosedCode</span><span class="o">[</span><span class="kt">Int</span><span class="o">]</span> <span class="k">=</span> <span class="n">code</span><span class="s">"(2).+(2).*(2)"</span>
</code></pre></div></div>

</section></div></div></div></div><script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/1.11.3/jquery.min.js"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/twitter-bootstrap/3.3.7/js/bootstrap.min.js"></script><script src="/squid/highlight/highlight.pack.js"></script><script>hljs.configure({
languages:['scala','java','bash']
});
hljs.initHighlighting();
             </script><script>((window.gitter = {}).chat = {}).options = {
room: 'epfldata-squid/Lobby'};</script><script src="https://sidecar.gitter.im/dist/sidecar.v1.js"></script><script src="/squid/js/main.js"></script></body></html>